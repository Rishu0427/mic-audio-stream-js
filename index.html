<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mic to Speaker with Delay</title>
</head>
<body>
<button onclick="toggleAudio()">Toggle Audio</button>

<script>
let audioContext;
let mediaStreamSource;
let isPlaying = false;
let delayNode;

function initAudio() {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  delayNode = audioContext.createDelay(0.5); // Adjust the delay time here (in seconds)
}

async function toggleAudio() {


  if (!isPlaying) {
    initAudio();

            const ctx = new AudioContext();

    navigator.mediaDevices.getUserMedia( {audio: {
    noiseSuppression: true,
    echoCancellation: true, // Optional: Enable echo cancellation
  }})
      .then(function(stream) {
            const gainNode = ctx.createGain();
            const audioDest = ctx.createMediaStreamDestination();
            const source = ctx.createMediaStreamSource(stream);

            // gainNode is set to 0.5
            gainNode.connect(audioDest);
            gainNode.gain.value = 0.5;   
            source.connect(gainNode);
        mediaStreamSource = audioContext.createMediaStreamSource(stream);
        mediaStreamSource.connect(delayNode);
        delayNode.connect(audioContext.destination);
        isPlaying = true;
      })
      .catch(function(err) {
        console.error('Error accessing microphone:', err);
      });
  } else {
    if (mediaStreamSource) {
      mediaStreamSource.disconnect();
      delayNode.disconnect();
      isPlaying = false;
    }
  }
}
</script>
</body>
</html>
